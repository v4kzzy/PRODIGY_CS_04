import ttkbootstrap as tb
from ttkbootstrap.constants import *
from tkinter import filedialog, messagebox
import hashlib

def calculate_hash(filepath):
    """
    Reads a file in chunks and calculates its SHA-256 hash.
    """
    sha256_hash = hashlib.sha256()
    
    try:
        with open(filepath, "rb") as f:
            for byte_block in iter(lambda: f.read(4096), b""):
                sha256_hash.update(byte_block)
        return sha256_hash.hexdigest()
    except Exception as e:
        return None

def process_file():
    filepath = entry_file.get()
    
    if not filepath:
        messagebox.showerror("Error", "Please select a file first!")
        return

    file_hash = calculate_hash(filepath)
    
    if file_hash:
        entry_result.delete(0, END)
        entry_result.insert(0, file_hash)
        lbl_status.config(text="Hash Calculated Successfully", bootstyle="success")
    else:
        messagebox.showerror("Error", "Could not read the file.")

def verify_integrity():
    current_hash = entry_result.get()
    expected_hash = entry_expected.get().strip()

    if not current_hash:
        messagebox.showerror("Error", "Calculate a file hash first!")
        return
    if not expected_hash:
        messagebox.showerror("Error", "Enter an expected hash to compare!")
        return

    if current_hash == expected_hash:
        messagebox.showinfo("Integrity Check", "MATCH: The file is authentic and unchanged.")
        lbl_status.config(text="Integrity Verified: Match", bootstyle="success")
    else:
        messagebox.showwarning("Integrity Check", "MISMATCH: The file has been altered!")
        lbl_status.config(text="Integrity Alert: Mismatch", bootstyle="danger")

def browse_file():
    filename = filedialog.askopenfilename()
    entry_file.delete(0, END)
    entry_file.insert(0, filename)

# --- GUI SETUP ---
app = tb.Window(themename="cyborg")
app.title("File Integrity Monitor")
app.geometry("600x500")

lbl_title = tb.Label(app, text="File Integrity Monitor (SHA-256)", font=("Helvetica", 16, "bold"), bootstyle="info")
lbl_title.pack(pady=20)

# Section 1: Select File
# FIXED: Changed LabelFrame to Labelframe (lowercase f)
frame_file = tb.Labelframe(app, text="1. Select File", bootstyle="info")
frame_file.pack(fill=X, padx=20, pady=10)

entry_file = tb.Entry(frame_file)
entry_file.pack(side=LEFT, fill=X, expand=YES, padx=10, pady=10)
btn_browse = tb.Button(frame_file, text="Browse", command=browse_file, bootstyle="outline")
btn_browse.pack(side=RIGHT, padx=10)

# Button to Calculate
btn_calc = tb.Button(app, text="Generate Hash Fingerprint", bootstyle="primary", command=process_file)
btn_calc.pack(pady=10)

# Section 2: Result
# FIXED: Changed LabelFrame to Labelframe
frame_result = tb.Labelframe(app, text="2. File Hash (Fingerprint)", bootstyle="warning")
frame_result.pack(fill=X, padx=20, pady=10)
entry_result = tb.Entry(frame_result, font=("Consolas", 10))
entry_result.pack(fill=X, padx=10, pady=10)

# Section 3: Verification (Optional)
# FIXED: Changed LabelFrame to Labelframe
frame_verify = tb.Labelframe(app, text="3. Verify Integrity (Optional)", bootstyle="success")
frame_verify.pack(fill=X, padx=20, pady=10)

entry_expected = tb.Entry(frame_verify, font=("Consolas", 10))
entry_expected.pack(side=LEFT, fill=X, expand=YES, padx=10, pady=10)
entry_expected.insert(0, "Paste original hash here to compare...")

btn_verify = tb.Button(frame_verify, text="Verify", command=verify_integrity, bootstyle="success")
btn_verify.pack(side=RIGHT, padx=10)

# Status
lbl_status = tb.Label(app, text="Ready...", bootstyle="secondary")
lbl_status.pack(side=BOTTOM, pady=10)

app.mainloop()